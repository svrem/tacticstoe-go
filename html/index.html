<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="stylesheet" href="assets/css/index.css" />
  </head>
  <body>
    <header class="header">
      <h1>Tacticstoe</h1>

      <user-profile />
    </header>
    <main>
      <div class="game-container" id="game-container">
        <button data-cell="0" class="cell"></button>
        <button data-cell="1" class="cell"></button>
        <button data-cell="2" class="cell"></button>
        <button data-cell="3" class="cell"></button>
        <button data-cell="4" class="cell"></button>
        <button data-cell="5" class="cell"></button>
        <button data-cell="6" class="cell"></button>
        <button data-cell="7" class="cell"></button>
        <button data-cell="8" class="cell"></button>
        <button data-cell="9" class="cell"></button>
        <button data-cell="10" class="cell"></button>
        <button data-cell="11" class="cell"></button>
        <button data-cell="12" class="cell"></button>
        <button data-cell="13" class="cell"></button>
        <button data-cell="14" class="cell"></button>
        <button data-cell="15" class="cell"></button>
      </div>
    </main>

    <div>
      <button>Play against bot</button>
      <button id="queue-button">Play against player</button>
    </div>

    <script>
      const game_container = document.getElementById("game-container");

      document.getElementById("queue-button").addEventListener("click", () => {
        const socket = new WebSocket("ws://192.168.117.243:8080/ws");

        const game_state = {
          player_id: null,
          active_player: null,
        };

        socket.onopen = function (e) {
          console.log("Connected to server");
        };
        socket.onmessage = function (event) {
          console.log("Message from server", event.data);
          const server_message = JSON.parse(event.data);

          switch (server_message.type) {
            case "game_start":
              game_container.setAttribute(
                "data-player-turn",
                server_message.data.starting_player === game_state.player_id
              );

              game_state.active_player = server_message.data.starting_player;
              break;

            case "join":
              console.log("Joined queue", server_message);
              game_state.player_id = server_message.data.id;
              break;

            case "game_update":
              const { x, y, state, active_player } = server_message.data;

              game_container.setAttribute(
                "data-player-turn",
                active_player === game_state.player_id
              );
              game_state.active_player = active_player;

              const cell_index = y * 4 + x;

              game_state.active_player = active_player;
              const cell = game_container.children[cell_index];

              cell.setAttribute("data-state", state);

              if (state === 1) {
                cell.innerHTML =
                  '<svg  xmlns="http://www.w3.org/2000/svg"  width="72"  height="72"  viewBox="0 0 24 24"  fill="none"  stroke="black"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>';
              } else if (state === 2) {
                cell.innerHTML =
                  '<svg  xmlns="http://www.w3.org/2000/svg"  width="72"  height="72"  viewBox="0 0 24 24"  fill="none"  stroke="black"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-circle"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /></svg>';
              }

              break;

            case "game_end":
              const clientIsWinner =
                server_message.data.winner === game_state.player_id;
              game_container.setAttribute("data-player-winner", clientIsWinner);

              const coords = server_message.data.coords;
              let coords_index = 0;

              const i = setInterval(() => {
                const [x, y] = coords[coords_index];
                const cell_index = y * 4 + x;
                const cell = game_container.children[cell_index];

                cell.setAttribute("data-winner", clientIsWinner);

                coords_index++;

                if (coords_index >= coords.length) {
                  clearInterval(i);
                }
              }, 300);

              break;
          }
        };

        function handleCellClick(e) {
          const cell_index = e.target.getAttribute("data-cell");

          const x = cell_index % 4;
          const y = Math.floor(cell_index / 4);

          socket.send(
            JSON.stringify({
              type: "action",
              data: {
                x,
                y,
              },
            })
          );
        }

        for (const cell of game_container.children) {
          cell.addEventListener("click", handleCellClick);
        }
      });
    </script>

    <script type="module" src="assets/js/user-profile.js"></script>
  </body>
</html>
